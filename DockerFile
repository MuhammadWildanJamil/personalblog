# ----------------------------------------------------
# TAHAP 1: BUILDER (Membuat output Next.js yang optimal)
# ----------------------------------------------------
FROM node:20-slim AS builder

WORKDIR /app

# Salin package.json dan package-lock.json (untuk cache)
COPY package.json yarn.lock ./

# Instal dependensi (termasuk devDependencies untuk proses build)
RUN yarn install --frozen-lockfile

# Salin seluruh kode proyek
COPY . .

# Lakukan Next.js Build
# Perintah ini akan menghasilkan folder .next/standalone
RUN yarn build


# ----------------------------------------------------
# TAHAP 2: RUNNER (Hanya komponen yang dibutuhkan saat runtime)
# ----------------------------------------------------
FROM node:20-slim AS runner

# 1. Mengatur user non-root (Sangat disarankan untuk keamanan)
RUN addgroup --gid 1001 nodejs
RUN adduser --uid 1001 --ingroup nodejs --shell /bin/sh --disabled-password nodejs

# 2. Salin output STANDALONE dari tahap builder (INI KRITIS)
WORKDIR /app
COPY --from=builder /app/public ./public
# Output standalone diletakkan di root
COPY --from=builder /app/.next/standalone ./

# 3. Salin node_modules produksi untuk runtime (jika diperlukan)
# Catatan: Karena menggunakan output standalone, ini sering kali sudah teratasi, 
# tetapi kadang dibutuhkan untuk symlink atau paket tertentu.
# Jika ada node_modules yang dibutuhkan, salin node_modules produksi
# COPY --from=builder /app/node_modules ./node_modules 

# 4. Tetapkan PORT
ENV PORT 3000
EXPOSE 3000

# Ganti user ke non-root
USER nodejs

# Perintah untuk menjalankan aplikasi
# Output standalone Next.js harus dijalankan melalui server.js yang dibuatnya.
CMD ["node", "server.js"]